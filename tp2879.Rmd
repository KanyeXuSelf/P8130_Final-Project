---
title: "Writing Scores Analysis"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(MASS)
library(car)
library(glmnet)
library(caret)
```


## Import and Clean the Data
```{r}
writing = read.csv(file = "./data/Project_1_data.csv") |> 
  janitor::clean_names() |> 
  mutate(across(where(is.character), ~na_if(.x, "")))
  
writing = writing |> 
  filter(!is.na(writing_score)) |> 
  drop_na()

head(writing)
```


## Descriptive Statistics
```{r}
summary(writing$writing_score)

var(writing$writing_score)
sd(writing$writing_score)
```


## Percentiles
```{r}
percentiles = quantile(writing$writing_score, probs = seq(0.1, 1, by = 0.1))

print(percentiles)
```


## Visualizations
```{r}
ggplot(writing, aes(x = writing_score)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  labs(
    title = "Distribution of Writing Scores",
    x = "Score",
    y = "Frequency")
```

```{r}
ggplot(writing, aes(x = writing_score)) +
  geom_density(fill = "purple", alpha = 0.5) +
  labs(
    title = "Density Plot of Writing Scores",
    x = "Writing Score",
    y = "Density")
```

```{r}
ggplot(writing, aes(x = gender, y = writing_score)) +
  geom_boxplot(fill = "lightblue") +
  labs(
    title = "Writing Scores by Gender",
    x = "Gender",
    y = "Writing Score")
```


```{r}
ggplot(writing, aes(x = ethnic_group, y = writing_score)) +
  geom_boxplot(fill = "lightgreen") +
  labs(
    title = "Writing Scores by Ethnic Group",
    x = "Ethnic Group",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = parent_educ, y = writing_score)) +
  geom_boxplot(fill = "lightpink") +
  labs(
    title = "Writing Scores by Parent Education",
    x = "Parent Education",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = lunch_type, y = writing_score)) +
  geom_boxplot(fill = "yellow") +
  labs(
    title = "Writing Scores by Lunch Type",
    x = "Lunch Type",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = test_prep, y = writing_score)) +
  geom_boxplot(fill = "orange") +
  labs(
    title = "Writing Scores by Test Prep",
    x = "Test Prep",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = parent_marital_status, y = writing_score)) +
  geom_boxplot(fill = "navyblue") +
  labs(
    title = "Writing Scores by Parent Marital Status",
    x = "Parent Marital Status",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = practice_sport, y = writing_score)) +
  geom_boxplot(fill = "thistle") +
  labs(
    title = "Writing Scores by Practice Sport",
    x = "Practice Sport",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = is_first_child, y = writing_score)) +
  geom_boxplot(fill = "sienna") +
  labs(
    title = "Writing Scores by First Child",
    x = "First Child",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = nr_siblings, y = writing_score)) +
  geom_boxplot(fill = "salmon") +
  labs(
    title = "Writing Scores by Number of Siblings",
    x = "Number of Siblings",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = transport_means, y = writing_score)) +
  geom_boxplot(fill = "royalblue") +
  labs(
    title = "Writing Scores by Transportation Means",
    x = "Transportation Means",
    y = "Writing Score")
```

```{r}
ggplot(writing, aes(x = wkly_study_hours, y = writing_score)) +
  geom_boxplot(fill = "orchid") +
  labs(
    title = "Writing Scores by Weekly Study Hours",
    x = "Weekly Study Hours",
    y = "Writing Score")
```

## Statistical Testing

### Linear Regression 
```{r}
lm_model = lm(writing_score ~ gender + ethnic_group + parent_educ + lunch_type + test_prep + parent_marital_status + practice_sport + is_first_child + nr_siblings + transport_means + wkly_study_hours, data = writing)

summary(lm_model)
```

### Correlation Matrix
```{r}
writing = writing |> 
  mutate(across(c(gender, ethnic_group, parent_educ, lunch_type, test_prep, parent_marital_status, practice_sport, is_first_child, nr_siblings, transport_means, wkly_study_hours), as.factor))

writing_encoded = writing |> 
  mutate(across(where(is.factor), as.numeric))

cor_writing = writing_encoded |> 
  select_if(is.numeric)

cor_matrix = cor(cor_writing, use = "complete.obs", method = "pearson")

print(cor_matrix)
```

```{r}
cor_table = knitr::kable(cor_matrix, format = "markdown")

print(cor_table)
```

### Backward Elimination Method
```{r}
full_model = lm(writing_score ~ gender + ethnic_group + parent_educ + lunch_type + test_prep + parent_marital_status + practice_sport + is_first_child + nr_siblings + transport_means + wkly_study_hours, data = writing)

backward_model = step(full_model, direction = "backward")

summary(backward_model)
```

Forward Selection
```{r}
empty_model = lm(writing_score ~ 1, data = writing)

forward_model = step(empty_model, 
                     scope = list(lower = empty_model, 
                                  upper = ~ gender + ethnic_group + parent_educ + lunch_type + test_prep + parent_marital_status + practice_sport + is_first_child + nr_siblings + transport_means + wkly_study_hours), direction = "forward")

summary(forward_model)
```


### Stepwise Method (stepAIC)
```{r}
null_model = lm(writing_score ~ 1, data = writing)

stepwise_model = stepAIC(full_model, direction = "both", trace = TRUE)

summary(stepwise_model)
```

### Checking for Multicollinearity
```{r}
vif_values = vif(lm_model)
print(vif_values)

high_vif = vif_values[vif_values > 5]
print(high_vif)
```

### Criterion-Based Procedures

Applying AIC-Based Stepwise Selection
```{r}
aic_stepwise = stepAIC(full_model, scope = list(lower = null_model, upper = full_model), direction = "both", trace = TRUE)

summary(aic_stepwise)
```

Applying BIC-Based Stepwise Selection
```{r}
n = nrow(writing)
bic_stepwise = stepAIC(full_model, scope = list(lower = null_model, upper = full_model), direction = "both", trace = TRUE, k = log(n))

summary(bic_stepwise)
```

### LASSO
```{r}
X = model.matrix(writing_score ~ gender + ethnic_group + parent_educ + lunch_type + test_prep + parent_marital_status + practice_sport + is_first_child + nr_siblings + transport_means + wkly_study_hours, data = writing)[, -1]

Y = writing$writing_score
```

```{r}
set.seed(123)
lasso_cv = cv.glmnet(X, Y, alpha = 1)
```

```{r}
best_lambda = lasso_cv$lambda.min
lasso_model = glmnet(X, Y, alpha = 1, lambda = best_lambda)
```

```{r}
lasso_coefficients = coef(lasso_model)
print(lasso_coefficients)
```

### Predictive Power through cross-validation
```{r}
set.seed(123)
train_control = trainControl(method = "cv", number = 10)

lasso_caret = train(
  writing_score ~ gender + ethnic_group + parent_educ + lunch_type + test_prep + parent_marital_status + practice_sport + is_first_child + nr_siblings + transport_means + wkly_study_hours, data = writing, method = "glmnet", trControl = train_control, tuneGrid = expand.grid(alpha = 1, lambda = seq(0.001, 1, length = 100)))

print(lasso_caret)
```

```{r}
predictions = predict(lasso_caret$finalModel, newx = X, s = lasso_caret$bestTune$lambda)

mse = mean((predictions - Y)^2)
r2 = 1 - (sum((Y - predictions)^2) / sum((Y - mean(Y))^2))
mae = mean(abs(predictions - Y))

print(paste("Test RMSE:", sqrt(mse)))
print(paste("Test R-Squared:", r2))
print(paste("Test MAE:", mae))
```

```{r}
dev.new()
plot(residuals(lasso_caret), main = "Residuals Plot", ylab = "Residuals")
abline(h = 0, col = "red")
```

### Interaction Effect
```{r}
interaction_model = lm(writing_score ~ gender * practice_sport + parent_educ * test_prep, data = writing)

summary(interaction_model)
```

ANOVA
```{r}
base_model = lm(writing_score ~ gender + practice_sport, data = writing)

anova(base_model, interaction_model)
```
